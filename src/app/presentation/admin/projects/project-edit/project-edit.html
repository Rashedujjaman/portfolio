<div class="project-edit-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <button mat-icon-button class="back-button" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h1>{{ isNewProject ? 'Create New Project' : 'Edit Project' }}</h1>
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="cancel()" [disabled]="isSaving">
          Cancel
        </button>
        <button 
          class="btn btn-primary" 
          (click)="saveProject()" 
          [disabled]="isSaving || uploadingImages">
          <span *ngIf="isSaving">{{ uploadingImages ? 'Uploading...' : 'Saving...' }}</span>
          <span *ngIf="!isSaving">{{ isNewProject ? 'Create Project' : 'Update Project' }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading project...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading" class="main-content">
    <form [formGroup]="projectForm" class="project-form">
      
      <!-- Project Information Section -->
      <div class="form-section">
        <h2>Project Information</h2>
        
        <div class="form-row">
          <div class="form-group full-width">
            <label for="title">Project Title *</label>
            <input 
              type="text" 
              id="title" 
              formControlName="title" 
              class="form-control"
              placeholder="Enter project title">
            <div class="error" *ngIf="projectForm.get('title')?.invalid && projectForm.get('title')?.touched">
              Title is required
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="shortDescription">Short Description *</label>
            <textarea 
              id="shortDescription" 
              formControlName="shortDescription" 
              class="form-control"
              rows="2"
              placeholder="Brief description for project cards..."></textarea>
            <div class="error" *ngIf="projectForm.get('shortDescription')?.invalid && projectForm.get('shortDescription')?.touched">
              Short description is required
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="description">Full Description *</label>
            <textarea 
              id="description" 
              formControlName="description" 
              class="form-control"
              rows="6"
              placeholder="Detailed project description..."></textarea>
            <div class="error" *ngIf="projectForm.get('description')?.invalid && projectForm.get('description')?.touched">
              Description is required
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="category">Category *</label>
            <select id="category" formControlName="category" class="form-control">
              <option value="">Select Category</option>
              <option value="web-application">Web Application</option>
              <option value="mobile-app">Mobile App</option>
              <option value="desktop-app">Desktop Application</option>
              <option value="api">API/Backend</option>
              <option value="library">Library</option>
              <option value="other">Other</option>
            </select>
            <div class="error" *ngIf="projectForm.get('category')?.invalid && projectForm.get('category')?.touched">
              Category is required
            </div>
          </div>

          <div class="form-group">
            <label for="status">Status *</label>
            <select id="status" formControlName="status" class="form-control">
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="planned">Planned</option>
              <option value="archived">Archived</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="technologies">Technologies</label>
            <textarea 
              id="technologies" 
              formControlName="technologiesInput" 
              class="form-control"
              rows="2"
              placeholder="Angular, TypeScript, Firebase, Node.js..."></textarea>
            <small class="form-help">Enter technologies separated by commas</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="demoUrl">Demo URL</label>
            <input 
              type="url" 
              id="demoUrl" 
              formControlName="demoUrl" 
              class="form-control"
              placeholder="https://demo.example.com">
          </div>

          <div class="form-group">
            <label for="githubUrl">GitHub URL</label>
            <input 
              type="url" 
              id="githubUrl" 
              formControlName="githubUrl" 
              class="form-control"
              placeholder="https://github.com/username/repo">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="featured"> 
              <span class="checkmark"></span>
              Featured Project
            </label>
            <small class="form-help">Featured projects appear prominently on the portfolio</small>
          </div>
        </div>
      </div>

      <!-- Image Management Section -->
      <div class="form-section">
        <h2>Project Images</h2>
        
        <!-- Image Upload Area -->
        <div class="image-upload-area">
          <input 
            type="file" 
            #fileInput 
            (change)="onFilesSelected($event)"
            accept="image/*"
            multiple
            style="display: none">
          
          <div class="upload-zone" (click)="fileInput.click()">
            <div class="upload-content">
              <div class="upload-icon">ðŸ“¸</div>
              <h3>Add Project Images</h3>
              <p>Click to select images or drag and drop</p>
              <small>Supported formats: JPG, PNG, GIF, WebP (max 5MB each)</small>
            </div>
          </div>
        </div>

        <!-- Upload Progress -->
        <div *ngIf="uploadingImages" class="upload-progress-section">
          <h3>Uploading Images...</h3>
          <div *ngFor="let item of uploadProgress | keyvalue" class="progress-item">
            <div class="progress-info">
              <span class="file-name">{{item.key}}</span>
              <span class="progress-percentage">{{item.value}}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="item.value"></div>
            </div>
          </div>
        </div>

        <!-- Current Images -->
        <div class="images-section">
          <h3 *ngIf="visibleImages.length > 0">Current Images ({{ visibleImages.length }})</h3>
          
          <div class="images-grid" *ngIf="visibleImages.length > 0">
            <div 
              *ngFor="let imageState of visibleImages; let i = index" 
              class="image-item"
              [class.new-image]="imageState.isNew"
              [class.uploading]="imageState.isNew && !imageState.isUploaded">
              
              <div class="image-preview">
                <img [src]="imageState.url" [alt]="'Project image ' + (i + 1)">
                <div class="image-overlay">
                  <button 
                    type="button" 
                    class="remove-btn"
                    (click)="removeImage(i)"
                    title="Remove image">
                    Ã—
                  </button>
                </div>
                <div class="image-status" *ngIf="imageState.isNew">
                  <span *ngIf="!imageState.isUploaded" class="status-badge new">New</span>
                  <span *ngIf="imageState.isUploaded" class="status-badge uploaded">Uploaded</span>
                </div>
              </div>
            </div>
          </div>

          <div class="empty-images" *ngIf="visibleImages.length === 0">
            <p>No images added yet. Use the upload area above to add project images.</p>
          </div>
        </div>

        <!-- Deleted Images (for undo) -->
        <div class="deleted-images-section" *ngIf="deletedImages.length > 0">
          <h3>Recently Removed ({{ deletedImages.length }})</h3>
          <p class="deleted-help">These images will be permanently deleted when you save the project.</p>
          
          <div class="deleted-images-grid">
            <div 
              *ngFor="let imageState of deletedImages; let i = index" 
              class="deleted-image-item">
              
              <div class="deleted-image-preview">
                <img [src]="imageState.url" [alt]="'Deleted image'">
                <div class="deleted-overlay">
                  <button 
                    type="button" 
                    class="undo-btn"
                    (click)="undoRemoveImage(i)"
                    title="Restore image">
                    â†¶ Undo
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Image Management Tips -->
        <div class="image-tips" *ngIf="hasNewImages">
          <div class="tip-box">
            <h4>ðŸ’¡ Image Management Tips</h4>
            <ul>
              <li>Images are uploaded to Firebase Storage when you save the project</li>
              <li>If project creation fails, uploaded images will be automatically cleaned up</li>
              <li>You can remove and restore images before saving</li>
              <li>First image will be used as the project thumbnail</li>
            </ul>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Status Messages -->
  <div class="status-message" *ngIf="statusMessage">
    <div class="alert" [class.alert-success]="!hasError" [class.alert-error]="hasError">
      {{ statusMessage }}
    </div>
  </div>

  <!-- Save Confirmation -->
  <div class="save-indicator" *ngIf="isSaving">
    <div class="save-overlay"></div>
    <div class="save-modal">
      <div class="save-content">
        <div class="save-spinner"></div>
        <h3 *ngIf="!uploadingImages">Saving Project...</h3>
        <h3 *ngIf="uploadingImages">Uploading Images...</h3>
        <p>Please don't close this page.</p>
      </div>
    </div>
  </div>
</div>
